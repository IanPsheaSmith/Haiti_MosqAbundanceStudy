cat("  MONTHLY:", species_name, "\n")
cat("-----------------------------------------------------------------------\n\n")
if (is.null(binary_ensemble)) {
cat("  ERROR: No binary ensemble\n")
return(NULL)
}
species_dir <- file.path(output_dir, "Monthly", species_code)
dir.create(species_dir, recursive = TRUE, showWarnings = FALSE)
start_time <- Sys.time()
for (i in seq_along(month_names)) {
month <- month_names[i]
cat("  [", i, "/12] ", month, "\n", sep = "")
month_stack <- monthly_stacks[[month]]
if (is.null(month_stack)) {
cat("    WARNING: No stack for", month, "\n")
next
}
# Presence (mean and SD only for monthly)
cat("    Presence: ")
pres_pred <- predict_ensemble_fast(binary_ensemble, month_stack,
calc_full_uncertainty = FALSE, verbose = FALSE)
if (!is.null(pres_pred)) {
writeRaster(pres_pred$mean,
file.path(species_dir, paste0(species_code, "_", month, "_Presence.tif")),
overwrite = TRUE)
writeRaster(pres_pred$sd,
file.path(species_dir, paste0(species_code, "_", month, "_Presence_SD.tif")),
overwrite = TRUE)
cat("mean =", round(cellStats(pres_pred$mean, mean, na.rm = TRUE), 4), "\n")
rm(pres_pred)
}
# Abundance
if (!is.null(count_ensemble)) {
cat("    Abundance: ")
abund_pred <- predict_ensemble_fast(count_ensemble, month_stack,
calc_full_uncertainty = FALSE, verbose = FALSE)
if (!is.null(abund_pred)) {
writeRaster(abund_pred$mean,
file.path(species_dir, paste0(species_code, "_", month, "_Abundance.tif")),
overwrite = TRUE)
cat("mean =", round(cellStats(abund_pred$mean, mean, na.rm = TRUE), 2), "\n")
rm(abund_pred)
}
}
gc(verbose = FALSE)
}
elapsed <- difftime(Sys.time(), start_time, units = "mins")
cat("\n  Monthly complete:", round(elapsed, 1), "min\n")
return(species_dir)
}
# =============================================================================
# BATCH PROCESSING FUNCTION
# =============================================================================
predict_all_species <- function(binary_ensembles,
count_ensembles = NULL,
species_list,
average_stack,
monthly_stacks = NULL,
output_dir = output_base,
do_baseline = TRUE,
do_monthly = TRUE) {
cat("\n=======================================================================\n")
cat("  BATCH PREDICTIONS - ALL SPECIES\n")
cat("=======================================================================\n\n")
cat("Species:", length(species_list), "\n")
cat("Baseline:", do_baseline, "\n")
cat("Monthly:", do_monthly, "\n\n")
start_time <- Sys.time()
results <- list()
for (i in seq_along(species_list)) {
sp <- species_list[i]
cat("\n***************************************************************\n")
cat("  SPECIES", i, "/", length(species_list), ":", species_mapping[sp], "\n")
cat("***************************************************************\n")
binary_ens <- binary_ensembles[[sp]]
count_ens <- if (!is.null(count_ensembles)) count_ensembles[[sp]] else NULL
if (is.null(binary_ens)) {
cat("  No binary ensemble - skipping\n")
next
}
result <- list(species = sp)
if (do_baseline) {
result$baseline <- predict_baseline_species(
species_code = sp,
binary_ensemble = binary_ens,
count_ensemble = count_ens,
average_stack = average_stack,
output_dir = output_dir
)
}
if (do_monthly && !is.null(monthly_stacks)) {
result$monthly <- predict_monthly_species(
species_code = sp,
binary_ensemble = binary_ens,
count_ensemble = count_ens,
monthly_stacks = monthly_stacks,
output_dir = output_dir
)
}
results[[sp]] <- result
gc(verbose = FALSE)
}
elapsed <- difftime(Sys.time(), start_time, units = "mins")
cat("\n=======================================================================\n")
cat("  ALL PREDICTIONS COMPLETE\n")
cat("=======================================================================\n\n")
cat("Total time:", round(elapsed, 1), "minutes\n")
cat("Average per species:", round(elapsed / length(species_list), 1), "minutes\n\n")
return(results)
}
# Run all predictions
results <- predict_all_species(
binary_ensembles = BRT_Bootstrap_Binary,
count_ensembles = BRT_Bootstrap_Count,
species_list = c("Aeae", "Aealb", "Quinx", "Aem", "Cxn", "Psc"),
average_stack = AverageStack,
monthly_stacks = MonthlyStacks,
do_baseline = TRUE,
do_monthly = TRUE
)
cat("\nFITTING BINARY MODELS\n")
set.seed(1999)
BRT_Bootstrap_Binary <- purrr::map2(species_list, dataset_names,
~fit_bootstrap_ensemble(.x, .y, n_bootstrap, "bernoulli")) %>%
purrr::set_names(species_list)
cat("\n\nFITTING COUNT MODELS\n")
set.seed(1999)
BRT_Bootstrap_Counts <- purrr::map2(species_list, dataset_names,
~fit_bootstrap_ensemble(.x, .y, n_bootstrap, "poisson")) %>%
purrr::set_names(species_list)
cat("\n\nAll bootstrap ensembles complete\n")
# =============================================================================
# BOOTSTRAP BRT ENSEMBLE PREDICTIONS - OPTIMIZED (SEQUENTIAL)
# =============================================================================
# Key finding: Parallel overhead >> prediction time for gbm models
# Sequential prediction: ~35 seconds for 100 models
# matrixStats for row operations: ~10 seconds
# Total per prediction: ~1-2 minutes (vs 50+ minutes with parallelization)
# =============================================================================
library(raster)
library(dismo)
library(gbm)
library(matrixStats)
library(dplyr)
library(purrr)
cat("\n=======================================================================\n")
cat("  BOOTSTRAP ENSEMBLE PREDICTIONS - SEQUENTIAL OPTIMIZED\n")
cat("  ~2 min per prediction (vs 50+ min with parallel overhead)\n")
cat("=======================================================================\n\n")
# =============================================================================
# CONFIGURATION
# =============================================================================
output_base <- "Predictions"
dir.create(output_base, recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(output_base, "Baseline"), recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(output_base, "Monthly"), recursive = TRUE, showWarnings = FALSE)
month_names <- c("January", "February", "March", "April", "May", "June",
"July", "August", "September", "October", "November", "December")
species_mapping <- c(
Aeae = "Aedes_aegypti",
Aealb = "Aedes_albopictus",
Quinx = "Culex_quinquefasciatus",
Aem = "Aedes_mediovittatus",
Cxn = "Culex_nigripalpus",
Psc = "Psorophora_columbiae"
)
cat("Output directory:", output_base, "\n\n")
# =============================================================================
# CORE PREDICTION FUNCTION - SEQUENTIAL + matrixStats
# =============================================================================
predict_ensemble_fast <- function(bootstrap_ensemble,
raster_stack,
calc_full_uncertainty = TRUE,
verbose = TRUE) {
if (is.null(bootstrap_ensemble) || bootstrap_ensemble$n_successful == 0) {
if (verbose) cat("    ERROR: No valid models in ensemble\n")
return(NULL)
}
models <- bootstrap_ensemble$models
n_models <- length(models)
covariates <- bootstrap_ensemble$covariates
if (verbose) {
cat("    Models:", n_models, "| Covariates:", length(covariates), "\n")
}
# Verify covariates
stack_names <- names(raster_stack)
missing_covs <- setdiff(covariates, stack_names)
if (length(missing_covs) > 0) {
if (verbose) cat("    ERROR: Missing covariates:", paste(missing_covs, collapse = ", "), "\n")
return(NULL)
}
# Subset and extract values
pred_stack <- raster::subset(raster_stack, covariates)
all_vals <- raster::getValues(pred_stack)
n_cells <- nrow(all_vals)
# Valid cells mask
valid_mask <- complete.cases(all_vals)
n_valid <- sum(valid_mask)
if (verbose) {
cat("    Cells:", format(n_valid, big.mark = ","), "valid /",
format(n_cells, big.mark = ","), "total\n")
}
if (n_valid == 0) {
if (verbose) cat("    ERROR: No valid cells\n")
return(NULL)
}
# Prepare prediction data
valid_df <- as.data.frame(all_vals[valid_mask, , drop = FALSE])
names(valid_df) <- covariates
rm(all_vals)
# Sequential prediction - FAST without parallel overhead
if (verbose) cat("    Predicting (sequential)...")
pred_start <- Sys.time()
pred_matrix <- sapply(models, function(m) {
predict(m, valid_df, n.trees = m$gbm.call$best.trees, type = "response")
})
pred_time <- difftime(Sys.time(), pred_start, units = "secs")
if (verbose) cat(" ", round(pred_time, 1), "sec\n")
# Calculate statistics with matrixStats
if (verbose) cat("    Computing statistics...")
stats_start <- Sys.time()
pred_mean_valid <- matrixStats::rowMeans2(pred_matrix)
pred_sd_valid <- matrixStats::rowSds(pred_matrix)
if (calc_full_uncertainty) {
quantiles_valid <- matrixStats::rowQuantiles(pred_matrix, probs = c(0.025, 0.975))
pred_lower_valid <- quantiles_valid[, 1]
pred_upper_valid <- quantiles_valid[, 2]
deviations <- abs(sweep(pred_matrix, 1, pred_mean_valid, "-"))
pred_agreement_valid <- matrixStats::rowMeans2(deviations < 0.1)
rm(deviations, quantiles_valid)
}
rm(pred_matrix)
stats_time <- difftime(Sys.time(), stats_start, units = "secs")
if (verbose) cat(" ", round(stats_time, 1), "sec\n")
# Create output rasters
template <- pred_stack[[1]]
pred_mean_full <- rep(NA_real_, n_cells)
pred_sd_full <- rep(NA_real_, n_cells)
pred_mean_full[valid_mask] <- pred_mean_valid
pred_sd_full[valid_mask] <- pred_sd_valid
result <- list(
mean = raster::setValues(template, pred_mean_full),
sd = raster::setValues(template, pred_sd_full),
n_models = n_models
)
names(result$mean) <- "mean"
names(result$sd) <- "sd"
if (calc_full_uncertainty) {
pred_lower_full <- rep(NA_real_, n_cells)
pred_upper_full <- rep(NA_real_, n_cells)
pred_agreement_full <- rep(NA_real_, n_cells)
pred_lower_full[valid_mask] <- pred_lower_valid
pred_upper_full[valid_mask] <- pred_upper_valid
pred_agreement_full[valid_mask] <- pred_agreement_valid
result$lower_ci <- raster::setValues(template, pred_lower_full)
result$upper_ci <- raster::setValues(template, pred_upper_full)
result$agreement <- raster::setValues(template, pred_agreement_full)
names(result$lower_ci) <- "lower_95ci"
names(result$upper_ci) <- "upper_95ci"
names(result$agreement) <- "agreement"
}
return(result)
}
# =============================================================================
# BASELINE PREDICTION FUNCTION
# =============================================================================
predict_baseline_species <- function(species_code,
binary_ensemble,
count_ensemble = NULL,
average_stack,
output_dir = output_base) {
species_name <- species_mapping[species_code]
cat("\n-----------------------------------------------------------------------\n")
cat("  BASELINE:", species_name, "\n")
cat("-----------------------------------------------------------------------\n")
if (is.null(binary_ensemble)) {
cat("  ERROR: No binary ensemble\n")
return(NULL)
}
species_dir <- file.path(output_dir, "Baseline", species_code)
dir.create(species_dir, recursive = TRUE, showWarnings = FALSE)
start_time <- Sys.time()
# Presence predictions
cat("\n  PRESENCE MODEL:\n")
presence_preds <- predict_ensemble_fast(binary_ensemble, average_stack,
calc_full_uncertainty = TRUE)
if (!is.null(presence_preds)) {
cat("    Saving rasters...\n")
writeRaster(presence_preds$mean,
file.path(species_dir, paste0(species_code, "_Presence_Mean.tif")),
overwrite = TRUE)
writeRaster(presence_preds$sd,
file.path(species_dir, paste0(species_code, "_Presence_SD.tif")),
overwrite = TRUE)
writeRaster(presence_preds$lower_ci,
file.path(species_dir, paste0(species_code, "_Presence_Lower95.tif")),
overwrite = TRUE)
writeRaster(presence_preds$upper_ci,
file.path(species_dir, paste0(species_code, "_Presence_Upper95.tif")),
overwrite = TRUE)
writeRaster(presence_preds$agreement,
file.path(species_dir, paste0(species_code, "_Presence_Agreement.tif")),
overwrite = TRUE)
cat("    Mean prob:", round(cellStats(presence_preds$mean, mean, na.rm = TRUE), 4), "\n")
}
# Abundance predictions
if (!is.null(count_ensemble)) {
cat("\n  ABUNDANCE MODEL:\n")
abundance_preds <- predict_ensemble_fast(count_ensemble, average_stack,
calc_full_uncertainty = TRUE)
if (!is.null(abundance_preds)) {
writeRaster(abundance_preds$mean,
file.path(species_dir, paste0(species_code, "_Abundance_Mean.tif")),
overwrite = TRUE)
writeRaster(abundance_preds$sd,
file.path(species_dir, paste0(species_code, "_Abundance_SD.tif")),
overwrite = TRUE)
writeRaster(abundance_preds$lower_ci,
file.path(species_dir, paste0(species_code, "_Abundance_Lower95.tif")),
overwrite = TRUE)
writeRaster(abundance_preds$upper_ci,
file.path(species_dir, paste0(species_code, "_Abundance_Upper95.tif")),
overwrite = TRUE)
# Combined metric
combined_mean <- presence_preds$mean * abundance_preds$mean
combined_sd <- sqrt(
(presence_preds$mean^2 * abundance_preds$sd^2) +
(abundance_preds$mean^2 * presence_preds$sd^2) +
(presence_preds$sd^2 * abundance_preds$sd^2)
)
writeRaster(combined_mean,
file.path(species_dir, paste0(species_code, "_Combined_Mean.tif")),
overwrite = TRUE)
writeRaster(combined_sd,
file.path(species_dir, paste0(species_code, "_Combined_SD.tif")),
overwrite = TRUE)
cat("    Mean abundance:", round(cellStats(abundance_preds$mean, mean, na.rm = TRUE), 2), "\n")
rm(abundance_preds, combined_mean, combined_sd)
}
}
rm(presence_preds)
gc(verbose = FALSE)
elapsed <- difftime(Sys.time(), start_time, units = "mins")
cat("\n  Baseline complete:", round(elapsed, 2), "min\n")
return(species_dir)
}
# =============================================================================
# MONTHLY PREDICTION FUNCTION
# =============================================================================
predict_monthly_species <- function(species_code,
binary_ensemble,
count_ensemble = NULL,
monthly_stacks,
output_dir = output_base) {
species_name <- species_mapping[species_code]
cat("\n-----------------------------------------------------------------------\n")
cat("  MONTHLY:", species_name, "\n")
cat("-----------------------------------------------------------------------\n\n")
if (is.null(binary_ensemble)) {
cat("  ERROR: No binary ensemble\n")
return(NULL)
}
species_dir <- file.path(output_dir, "Monthly", species_code)
dir.create(species_dir, recursive = TRUE, showWarnings = FALSE)
start_time <- Sys.time()
for (i in seq_along(month_names)) {
month <- month_names[i]
cat("  [", i, "/12] ", month, "\n", sep = "")
month_stack <- monthly_stacks[[month]]
if (is.null(month_stack)) {
cat("    WARNING: No stack for", month, "\n")
next
}
# Presence (mean and SD only for monthly)
cat("    Presence: ")
pres_pred <- predict_ensemble_fast(binary_ensemble, month_stack,
calc_full_uncertainty = FALSE, verbose = FALSE)
if (!is.null(pres_pred)) {
writeRaster(pres_pred$mean,
file.path(species_dir, paste0(species_code, "_", month, "_Presence.tif")),
overwrite = TRUE)
writeRaster(pres_pred$sd,
file.path(species_dir, paste0(species_code, "_", month, "_Presence_SD.tif")),
overwrite = TRUE)
cat("mean =", round(cellStats(pres_pred$mean, mean, na.rm = TRUE), 4), "\n")
rm(pres_pred)
}
# Abundance
if (!is.null(count_ensemble)) {
cat("    Abundance: ")
abund_pred <- predict_ensemble_fast(count_ensemble, month_stack,
calc_full_uncertainty = FALSE, verbose = FALSE)
if (!is.null(abund_pred)) {
writeRaster(abund_pred$mean,
file.path(species_dir, paste0(species_code, "_", month, "_Abundance.tif")),
overwrite = TRUE)
cat("mean =", round(cellStats(abund_pred$mean, mean, na.rm = TRUE), 2), "\n")
rm(abund_pred)
}
}
gc(verbose = FALSE)
}
elapsed <- difftime(Sys.time(), start_time, units = "mins")
cat("\n  Monthly complete:", round(elapsed, 1), "min\n")
return(species_dir)
}
# =============================================================================
# BATCH PROCESSING FUNCTION
# =============================================================================
predict_all_species <- function(binary_ensembles,
count_ensembles = NULL,
species_list,
average_stack,
monthly_stacks = NULL,
output_dir = output_base,
do_baseline = TRUE,
do_monthly = TRUE) {
cat("\n=======================================================================\n")
cat("  BATCH PREDICTIONS - ALL SPECIES\n")
cat("=======================================================================\n\n")
cat("Species:", length(species_list), "\n")
cat("Baseline:", do_baseline, "\n")
cat("Monthly:", do_monthly, "\n\n")
start_time <- Sys.time()
results <- list()
for (i in seq_along(species_list)) {
sp <- species_list[i]
cat("\n***************************************************************\n")
cat("  SPECIES", i, "/", length(species_list), ":", species_mapping[sp], "\n")
cat("***************************************************************\n")
binary_ens <- binary_ensembles[[sp]]
count_ens <- if (!is.null(count_ensembles)) count_ensembles[[sp]] else NULL
if (is.null(binary_ens)) {
cat("  No binary ensemble - skipping\n")
next
}
result <- list(species = sp)
if (do_baseline) {
result$baseline <- predict_baseline_species(
species_code = sp,
binary_ensemble = binary_ens,
count_ensemble = count_ens,
average_stack = average_stack,
output_dir = output_dir
)
}
if (do_monthly && !is.null(monthly_stacks)) {
result$monthly <- predict_monthly_species(
species_code = sp,
binary_ensemble = binary_ens,
count_ensemble = count_ens,
monthly_stacks = monthly_stacks,
output_dir = output_dir
)
}
results[[sp]] <- result
gc(verbose = FALSE)
}
elapsed <- difftime(Sys.time(), start_time, units = "mins")
cat("\n=======================================================================\n")
cat("  ALL PREDICTIONS COMPLETE\n")
cat("=======================================================================\n\n")
cat("Total time:", round(elapsed, 1), "minutes\n")
cat("Average per species:", round(elapsed / length(species_list), 1), "minutes\n\n")
return(results)
}
# Run all predictions
results <- predict_all_species(
binary_ensembles = BRT_Bootstrap_Binary,
count_ensembles = BRT_Bootstrap_Count,
species_list = c("Aeae", "Aealb", "Quinx", "Aem", "Cxn", "Psc"),
average_stack = AverageStack,
monthly_stacks = MonthlyStacks,
do_baseline = TRUE,
do_monthly = TRUE
)
# Run all predictions
results <- predict_all_species(
binary_ensembles = BRT_Bootstrap_Binary,
count_ensembles = BRT_Bootstrap_Counts,
species_list = c("Aeae", "Aealb", "Quinx", "Aem", "Cxn", "Psc"),
average_stack = AverageStack,
monthly_stacks = MonthlyStacks,
do_baseline = TRUE,
do_monthly = TRUE
)
# Run all predictions
results <- predict_all_species(
binary_ensembles = BRT_Bootstrap_Binary,
count_ensembles = BRT_Bootstrap_Counts,
species_list = c("Aeae", "Aealb", "Quinx", "Aem", "Cxn", "Psc"),
average_stack = AverageStack,
monthly_stacks = MonthlyStacks,
do_baseline = TRUE,
do_monthly = TRUE
)
library(readr)
library(raster)
library(dismo)
library(sf)
library(lctools)
library(ggplot2)
library(ggfortify)
library(dplyr)
library(rJava) # NOTE - Java must be installed on the computer or maxent() will not work
library(dismo)
library(RColorBrewer)
library(pROC)
library(jsonlite)
library(gridExtra)
library(exactextractr)
library(viridis)
